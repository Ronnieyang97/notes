第九章 IP选路
路由表中包含的信息决定了IP层所作的所有决策，当接收到ICMP重定向报文时，路由表也要被更新（netstat）

IP搜索路由表的步骤：
1）搜索匹配的主机地址
2）搜索匹配的网络地址
3)搜索默认表项（一般在路由表中被指定为一个网络表项，其网络号为0）
匹配主机地址步骤发生于匹配网络地址步骤之前
IP层搜索路由表并决定向哪个网络接口发送分组，它时一组决定把哪些路由放入路由表的规则，而路由守护程序一般提供选路策略

执行netstat后，会出现多列数据：
destination标识目的地址
gateway表示网关（路由器）将把分组转给该地址
flags代表五种不同的标志：
	U 该路由可以使用
	G 该路由是到一个网关（路由器），如果没有该标志，说明目的地址是直接相连的
	H 该路由是到一个主机，也就是说，目的地址是一个完整的主机地址。如果没有该标志，说明该路由是到一个网络，而目的地址是一个网络地址（网络号，或网络号与子网号的组合）
	D 该路由是又重定向报文创建的
	M 该路由已被重定向报文修改
	标志G区分了间接路由和直接路由。区别在于发往直接路由的分组中不但具有指明目的端的IP地址，还具有其链路层地址当分组被发往一个简介路由时，IP地址指明的是最终的目的地，但是链路层地址指明的是网关
Refcnt 参考记数列给出的是正在使用路由的活动进程个数。面向链接的协议如TCP在建立链接时要固定路由，如果在主机之间建立Talnet链接，参考记数值变为1，建立另一个Talnet链接时，将增加为2
use列显示的是通过该路由发送的分组数
interface是本地接口的名字

主机路由表的复杂性取决于主机所在网络的拓扑结构
1）最简单的情况是主机根本没有与任何网络相连，TCP/IP协议仍然适用，但是只能与自己本身通信，这种情况下路由表只包含环回接口
2）主机连在一个局域网上，只能访问局域网上的主机，这时路由表包含两项：一项是环回接口，另一项就是局域网
3）如果主机能够通过单个路由器访问其他网络时，那么就增加一个默认表项指向该路由器
4）如果要新增其他的特定主机或网络路由，那么就要进行最后一步。

路由表的创建：每当初始化一个接口，就为接口自动创建一个直接路由，到达主机或网络的路由如果不是直接相连的，就必须加入路由表。

当路由器收到一份IP数据报但又不能转发时，就要发送一份ICMP主机不可达差错报文
主机默认不转发IP数据报

当IP数据报应该被发送到另一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给IP数据报的发送端
当主机发送一份IP数据报给R（主机的默认路由）
R1收到数据报并检查他的路由表，发现R2是发送该数据报的下一站，当它把数据报发送给R2时，R1检测到他正在发送的接口与数据报到达接口是相同的，这样就给路由器发送重定向报文提供了线索
R1发送一份ICMP重定向报文给主机告诉他以后把数据发送给R2而不是R1
重定向能建立更完善的路由表，使智能特性放在路由器端

重定向报文有四种，ICMP重定向报文的接收者必须查看三个IP地址：
1）导致重定向的IP地址（即ICMP重定向报文的数据位于IP数据报的首部）
2）发送重定向报文的路由器的IP地址（包含重定向信息的IP数据报中的源地址）
3）应该采用的路由器IP地址（在ICMP报文中的4-7字节）

ICMP重定向报文的规则：
首先，重定向报文只能由路由器生成，不能由主机生成
另外，重定向报文是为主机而不是路由器使用的，假定路由器和其他一些路由器共同参与某种选路协议，则该协议就能消除重定向的需要

在主机作为路由器使用的时候：
1）出接口必须等于入接口
2）用于向外传送数据的路由不能被ICMP重定向报文创建或修改过，而且不能是路由器默认路由
3）数据报不能用源站选路来转发
4）内核必须配置成可发送重定向报文

在收到ICMP重定向报文，修改路由表之前要做一些检查
1）新的路由器必须直接与网络相连接
2）重定向报文必须来自当前到目的地所选择的路由器
3）重定向报文不能让主机本身作为路由器
4）被修改的路由必须是一个间接路由

路由器应该发送的是对主机的重定向而不是对网络的重定向

主机在引导后要广播或多播传送一份路由器请求报文，一台或更多台路由器响应一份路由器通告报文；另外，路由器定期地广播或多播传送它们的路由器通告报文，允许每个正在监听的主机相应的更新他们的路由表
路由器在一份报文中可以通告多个地址，地址数指的是报文中所包含的地址数，地址项大小是指每个路由器地址32bit字的数目，始终为2，生存期指的是通告地址有效时间

路由器启动时定期在所有广播或多播传播接口上发送通告报文，（随机传送以减小与子网其他路由器发生冲突的概率）；路由器还要监听来自主机的请求报文，并发送路由器通告以响应这些请求报文
主机在引导期间一般发送三份路由器请求报文，一旦收到一个有效的通告报文，就停止发送请求报文；主机也监听来自相邻路由器的请求报文，这些通告报文可以改变主机的默认路由器，如果没有接收到来自当前默认路由器的通告报文，那么路由器会超时
路由器发现报文由用户进程创建和处理
##########################################################################################################################################################################################
习题
9.1 为什么存在两类ICMP重定向报文--网络和主机？
使用一个网络重定向而不是N个主机重定向（目的网络中的N个主机节省了路由表的空间）

9.3 有一电缆连接4.2BSD主机和4.3BSD主机，网络号是140.1，4.2BSD主机把主机号为全0的地址识别为广播地址（140.1.0.0）而4.3BSD通常使用全1的主机号（140.1.255.255）发送广播。另外，4.2BSD主机在默认条件下要尽力转发接收到的数据报。请描述当4.2BSD主机收到一份目的地址为140.1.255.255的IP数据报时会发生什么事
当4.2BSD主机收到目的地址为140.1.255.255的数据报，发现它有一个通往该网络的路由（140.1）因此试图转发次数据报。他发送一个ARP广播来寻找140.1.255.255，这个ARP请求没有受到任何应答，所以这个数据报最终被丢弃，如果在网线上有很多个这样的4.2BSD，每一个都在差不多的时间内发送这个ARP广播，将会暂时的阻塞网络

9.4 在上题的条件下，假定子网140.1上的某个系统ARP高速缓存中增加了一项内容，指定IP地址为140.1.255.255对应的以太网地址全为1（以太网广播地址），请描述此时发生的情况
这次每个ARP请求都收到一个应答，告诉每个4.2BSD主机向一个指定的硬件地址发送数据报。如果网线上有k个这样的4.2BSD主机，全部收到了他们自己的ARP应答，使每一个生成了另外一个广播，每个主机都收到了每一个目的地址为140.1.255.255的广播数据IP报，既然现在每个主机都有一个ARP缓存项，这个数据报又被转发给了广播地址，这个过程继续下去就会产生一次以太网的熔毁（网络中一种形式的链式反应）
